# Created by mumblebaj

name: Build and Deploy API Documentation

on:
  push:
    branches:
      - main
    paths:
      - 'docs/index.html'
      - 'docs/openapiEditor.html'
      - 'docs/xmlViewer.html'
      - 'js/xsdViewer.js'
      - 'js/yamlViewer.js'
      - 'js/openapiEditor.js'
      - 'js/xmlViewer.js'
      - 'js/viewTracker.js'
      - 'css/style.css'
      - 'css/openapiEditor.css'
      - 'js/template.js'
      - 'js/buildVersion.js'
      - 'build-info.json'
      - 'tutor/**'
      - 'js/exporter/docModel.js'
      - 'js/exporter/downloadUtils.js'
      - 'js/exporter/exportConfluence.js'
      - 'js/exporter/exportMarkdown.js'
      - 'js/schemaExport/**'
      - 'js/ui/**'
      - 'vendor/redoc/redoc.standalone.min.js'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1. Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Bump version and update build-info.json
      - name: Update build-info.json
        id: buildinfo
        run: |
          FILE=build-info.json
          if [ ! -f "$FILE" ]; then
            echo '{"version":"1.0.0","commit":"","date":"","cacheTag":""}' > "$FILE"
          fi

          VERSION=$(jq -r '.version' "$FILE")
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)

          # Increment PATCH and roll over every 10 builds
          PATCH=$((PATCH + 1))
          if [ $PATCH -ge 10 ]; then
            PATCH=0
            MINOR=$((MINOR + 1))
          fi

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"

          CACHE_TAG=$(date -u +'%Y%m%dT%H%M%SZ')

          echo "{
            \"version\": \"${NEW_VERSION}\",
            \"commit\": \"$(git rev-parse --short HEAD)\",
            \"date\": \"$(date -u +'%Y-%m-%dT%H:%M:%SZ')\",
            \"cacheTag\": \"${CACHE_TAG}\"
          }" > "$FILE"

          echo "cache_tag=${CACHE_TAG}" >> $GITHUB_OUTPUT
          echo "✅ Bumped version to $NEW_VERSION with cacheTag ${CACHE_TAG}"


      # 2b. Inject cache-busting version strings
      - name: Inject cache-busting version strings
        run: |
          VERSION_TAG=${{ steps.buildinfo.outputs.cache_tag }}
          echo "Injecting cache-busting tag: $VERSION_TAG"

          # --- Update HTML query strings ---
          find docs -name "*.html" -type f -exec \
            sed -i "s#?v=[0-9a-zA-ZT:-]*#?v=${VERSION_TAG}#g" {} +

          # --- Update JS 'const version = "...";' lines ---
          find js -name "*.js" -type f -exec \
            sed -i "s#?v=[0-9a-zA-ZT:-]*#?v=${VERSION_TAG}#g" {} +

          echo "✅ Updated HTML + JS with cache-busting version"

      # 3. Commit updated files
      - name: Commit updated files
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add build-info.json docs/*.html js/*.js
          git commit -m "chore: bump build to $(jq -r '.version' build-info.json) [${{ steps.buildinfo.outputs.cache_tag }}]" || echo "No changes to commit"
          git push

      # 4. Create build directory
      - name: Create build directory
        run: mkdir -p public

      # 5. Copy landing page into public
      - name: Copy landing page
        run: cp docs/index.html public/index.html

      # 6. Copy openapiEditor page
      - name: Copy openapiEditor page
        run: cp docs/openapiEditor.html public/openapiEditor.html

      # 7. Copy xmlViewer.html page
      - name: Copy xmlViewer.html page
        run: cp docs/xmlViewer.html public/xmlViewer.html

      # 7b. Copy Tutor page
      - name: Copy tutor/index.html
        run: |
          mkdir -p public/tutor
          cp tutor/index.html public/tutor/index.html

      # 8. Copy build-info.json into public
      - name: Copy build-info.json
        run: cp build-info.json public/build-info.json

      # 9. Copy JS files
      - name: Copy JS files
        run: |
          mkdir -p public/js
          cp js/*.js public/js/

      # 9b. Copy Tutor JS
      - name: Copy Tutor JS files
        run: |
          mkdir -p public/tutor/js
          cp tutor/js/*.js public/tutor/js/

      # 9c. Copy Tutor Lessons
      - name: Copy Tutor lesson files
        run: |
          mkdir -p public/tutor/lessons
          cp tutor/lessons/*.md public/tutor/lessons/
      
      # 9d. Copy exporter JS
      - name: Copy exporter JS files
        run: |
          mkdir -p public/js/exporter
          cp js/exporter/*.js public/js/exporter/
        
      # 9e. Copy schemaExport JS
      - name: Copy schemaExport JS files
        run: |
          mkdir -p public/js/schemaExport
          cp js/schemaExport/*.js public/js/schemaExport/

      # 9f. Copy ui JS
      - name: Copy ui JS files
        run: |
          mkdir -p public/js/ui
          cp js/ui/*.js public/js/ui/

      # 10. Copy CSS files
      - name: Copy CSS files
        run: |
          mkdir -p public/css
          cp css/*.css public/css/

      # 10b. Copy Tutor CSS
      - name: Copy Tutor CSS files
        run: |
          mkdir -p public/tutor/css
          cp tutor/styles.css public/tutor/styles.css

      # 11. Copy favicons
      - name: Copy favicons
        run: |
          cp docs/favicon.svg public/favicon.svg
          cp docs/favicon.png public/favicon.png

      # 12. Copy CNAME
      - name: Copy CNAME
        run: cp docs/CNAME public/CNAME

      # 13. Copy Vendor Files
      - name: Copy CNAME
        run: |
          mkdir -p public/vendor/redoc
          cp vendor/redoc/redoc.standalone.min.js public/vendor/redoc/redoc.standalone.min.js

      # 14. Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
